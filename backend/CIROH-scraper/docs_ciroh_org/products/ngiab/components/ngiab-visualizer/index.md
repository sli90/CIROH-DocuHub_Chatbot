# NGIAB Data Visualizer

[Skip to main content](https://docs.ciroh.org/docs/products/ngiab/components/ngiab-visualizer/#__docusaurus_skipToContent_fallback)

> **NOTE**
>
>  Below content is rendered from [https://github.com/CIROH-UA/ngiab-client/blob/main/README.md](https://github.com/CIROH-UA/ngiab-client/blob/main/README.md).

|  |  |
| --- | --- |
| [![CIROH Logo](https://camo.githubusercontent.com/f1425ea9a6a4492162f5ff3a63a5d0827fc95442381ae96e095095c7afd57152/68747470733a2f2f6369726f682e75612e6564752f77702d636f6e74656e742f75706c6f6164732f323032322f30382f4349524f484c6f676f5f323030783230302e706e67)](https://camo.githubusercontent.com/f1425ea9a6a4492162f5ff3a63a5d0827fc95442381ae96e095095c7afd57152/68747470733a2f2f6369726f682e75612e6564752f77702d636f6e74656e742f75706c6f6164732f323032322f30382f4349524f484c6f676f5f323030783230302e706e67) | Funding for this project was provided by the National Oceanic & Atmospheric Administration (NOAA), awarded to the Cooperative Institute for Research to Operations in Hydrology (CIROH) through the NOAA Cooperative Agreement with The University of Alabama (NA22NWS4320003). |

This app was created using an experimental Tethys + React app scaffold. It uses React for the frontend of the app and Tethys as the backend.

[![Data Visualizer Interface](https://github.com/CIROH-UA/ngiab-client/raw/main/static/imgs/fig6-1.png)](https://github.com/CIROH-UA/ngiab-client/blob/main/static/imgs/fig6-1.png)

The Data Visualizer component provides:

- **Geospatial visualization** of catchments and nexus points
- **Time series analysis** of catchments, nexus points, and troute variables
- **TEEHR output visualization** including metrics and interactive plots

Built on the Tethys Platform [(Swain et al., 2015)](https://doi.org/10.1016/j.envsoft.2015.01.014), it enables web-based exploration of model outputs [(CIROH, 2025)](https://github.com/CIROH-UA/ngiab-client).

## Usage Guide

### Assited using `ViewOnTethys` Script

Like TEEHR, the Data Visualizer can be activated upon execution of the main NGIAB guide script, `guide.sh`. A separate `viewOnTethys.sh` script is also available in the NGIAB-CloudInfra repository.

Once a run is complete, users can launch the Data Visualizer through their web browser when prompted by the guide script. Although TEEHR's outputs can be displayed within the Data Visualizer, this tool is primarily designed to provide a broad overview of model results. Users seeking TEEHR's more advanced analysis features can still access them outside the Data Visualizer.

One of the advantages of the `viewOnTethys.sh` script is that it allows the user to keep multiple outputs for the same hydrofabric. It prompts the user if they want to use the same output directory by renaming it and adding it to the collection of outputs or if they want to overwrite it.

```
  ⚠ ~/ngiab_visualizer is not empty.
  → Keep (K) or Fresh start (F)? [K/F]: k
ℹ Reclaiming ownership of ~/ngiab_visualizer  (sudo may prompt)…
  ⚠ Directory exists: ~/ngiab_visualizer/gage-10154200
  → Overwrite (O) or Duplicate (D)? [O/D]: o
  ✓ Overwritten ➜ ~/ngiab_visualizer/gage-10154200
Checking for ~/ngiab_visualizer/ngiab_visualizer.json...
```

You should be able to see multiple outputs through the UI:

[![Figure 2: NGIAB Visualizer dropdown for multiple outputs ](https://github.com/CIROH-UA/ngiab-client/raw/main/static/imgs/fig6-2.png)](https://github.com/CIROH-UA/ngiab-client/blob/main/static/imgs/fig6-2.png){alt='A screenshot of the NGIAB and DataStream Visualizer web interface. The map displays the ability of the visualizer to use multiple outputs'}

#### Visualizer Directory Organization

The Visualizer organizes data using a directory named `ngiab_visualizer`. This directory stores all the outputs generated by the user and includes a file called `ngiab_visualizer.json`. This file contains metadata that allows the Visualizer to locate and manage the outputs from different runs executed via the `./guide.sh` script. The metadata, specific to the Visualizer, is structured as a simple JSON file. It lists the outputs with details such as a label, the data path, and a unique identifier. The `./ViewOnTethys.sh` script handles the creation and management of this metadata.

```
{
  "model_runs": [\
    {\
      "label": "gage-10154200",\
      "path": "/var/lib/tethys_persist/ngiab_preprocess_output/gage-10154200",\
      "date": "2025-05-23:13:51:51",\
      "id": "61026834-4235-4d39-8a8e-f076a8854148",\
      "subset": "",\
      "tags": []\
    },\
    {\
      "label": "gage-20454200",\
      "path": "/var/lib/tethys_persist/ngiab_visualizer/gage-20454200",\
      "date": "2025-05-23:17:00:34",\
      "id": "68f6cf78-188c-4e86-b797-6c40ea36e0e6",\
      "subset": "",\
      "tags": []\
    },\
    {\
      "label": "gage-35054600",\
      "path": "/var/lib/tethys_persist/ngiab_visualizer/gage-35054600",\
      "date": "2025-05-23:17:01:10",\
      "id": "6d0cb736-2dac-4ea0-a3a3-ad26cd45ef36",\
      "subset": "",\
      "tags": []\
    }\
  ]
}

```

The path `/var/lib/tethys_persist/` belongs to the `$HOME` env variable of the container running the visualizer. When the user runs the `./ViewOnTethys.sh`, it mounts the directory from the host at `~/ngiab_visualizer` to `/var/lib/tethys_persist/ngiab_visualizer`.

However, if the user wants more control, the user can copy their data directory to `~/ngiab_visualizer` on the host(not the container) while the container is **stop**,

```
chown -R $USER: ~/ngiab_visualizer
cp -R your/data/path ~/ngiab_visualizer
```

Finally the user can open the `~/ngiab_visualizer/ngiab_visualizer.json` on the host(not the container), and add the specific run to the visualizer:

```
....
    {
      "label": "gage-35054600",
      "path": "/var/lib/tethys_persist/ngiab_visualizer<MY_SPECIFIC_OUTPUT_DIRECTORY_NAME>",
      "date": "2025-05-23:17:01:10",
      "id": "6d0cb736-2dac-4ea0-a3a3-ad26cd45ef36",
      "subset": "",
      "tags": []
    }
```

The user can then run `./ViewOnTethys.sh` script to spin again the container or if the user wants more control and just define the env variables and running the container

### Unassisted Usage

First create the `MODELS_RUNS_DIRECTORY` directory at `"$HOME/ngiab_visualizer"`, and `DATASTREAM_DIRECTORY` directory at `"$HOME/.datastream_ngiab"`, and `VISUALIZER_CONF` file at `"$MODELS_RUNS_DIRECTORY/ngiab_visualizer.json"`

Copy your `my-ngen-output` into the `MODELS_RUNS_DIRECTORY` directory, and then edit the `"$MODELS_RUNS_DIRECTORY/ngiab_visualizer.json"` fie and add the your output as below.

```
{
    "model_runs": [\
        ...\
        {\
            "label": "my-ngen-output",\
            "path": "/var/lib/tethys_persist/my-ngen-output",\
            "date": "2025-05-23:13:51:51",\
            "id": "61026834-4235-4d39-8a8e-f076a8854148", #it can be any ID\
            "subset": "",\
            "tags": []\
        },\
        ...\
    ]
}
```

Define the env variables and running the container

```
# Set environment variables
export TETHYS_CONTAINER_NAME="tethys-ngen-portal"        \
       TETHYS_REPO="awiciroh/tethys-ngiab"               \
       TETHYS_TAG="latest"                               \
       NGINX_PORT=80                                     \
       MODELS_RUNS_DIRECTORY="$HOME/ngiab_visualizer"    \
       DATASTREAM_DIRECTORY="$HOME/.datastream_ngiab"    \
       VISUALIZER_CONF="$MODELS_RUNS_DIRECTORY/ngiab_visualizer.json" \
       TETHYS_PERSIST_PATH="/var/lib/tethys_persist"     \
       SKIP_DB_SETUP=false                               \
       CSRF_TRUSTED_ORIGINS="[\"http://localhost:${NGINX_PORT}\",\"http://127.0.0.1:${NGINX_PORT}\"]"
```

# Run container

```
docker run --rm -d \
  -v "$MODELS_RUNS_DIRECTORY:$TETHYS_PERSIST_PATH/ngiab_visualizer" \
  -v "$DATASTREAM_DIRECTORY:$TETHYS_PERSIST_PATH/.datastream_ngiab" \
  -p "$NGINX_PORT:$NGINX_PORT" \
  --name "$TETHYS_CONTAINER_NAME" \
  -e MEDIA_ROOT="$TETHYS_PERSIST_PATH/media" \
  -e MEDIA_URL="/media/" \
  -e SKIP_DB_SETUP="$SKIP_DB_SETUP" \
  -e DATASTREAM_CONF="$TETHYS_PERSIST_PATH/.datastream_ngiab" \
  -e VISUALIZER_CONF="$TETHYS_PERSIST_PATH/ngiab_visualizer/ngiab_visualizer.json" \
  -e NGINX_PORT="$NGINX_PORT" \
  -e CSRF_TRUSTED_ORIGINS="$CSRF_TRUSTED_ORIGINS" \
  "${TETHYS_REPO}:${TETHYS_TAG}"
```

Verify deployment:

```
docker ps
# CONTAINER ID   IMAGE                          PORTS                 NAMES
# b1818a03de9b   awiciroh/tethys-ngiab:latest   0.0.0.0:80->80/tcp    tethys-ngen-portal
```

Access at: [http://localhost:80](http://localhost/)

### Visualization Features

**Nexus** points can be visualized when the user selects the output that wants to visualize. Time series can be retrieved by clicking on any of the **Nexus** points, or by changing the select dropdown assigned to the Nexus.

[![Figure 3: NGIAB Visualizer time series visualization from Nexus points](https://github.com/CIROH-UA/ngiab-client/raw/main/static/imgs/fig6-3.png)](https://github.com/CIROH-UA/ngiab-client/blob/main/static/imgs/fig6-3.png){alt='A screenshot of the NGIAB and DataStream Visualizer web interface. The map displays the ability of the visualizer to retrieve time series from Nexus points'}

**Troute** variables time series can also be displayed using the **Troute** select dropdown.

[![Figure 4: NGIAB Visualizer time series visualization from Troute variables](https://github.com/CIROH-UA/ngiab-client/raw/main/static/imgs/fig6-4.png)](https://github.com/CIROH-UA/ngiab-client/blob/main/static/imgs/fig6-4.png){alt='A screenshot of the NGIAB and DataStream Visualizer web interface. The map displays the ability of the visualizer to retrieve time series from Troute variables'}

**Catchments** time series can be retrieved by clicking on any of the **Catchments** polygons, or by changing the select dropdown assigned to the Catchments.

[![Figure 5: NGIAB Visualizer time series visualization for Catchments](https://github.com/CIROH-UA/ngiab-client/raw/main/static/imgs/fig6-5.png)](https://github.com/CIROH-UA/ngiab-client/blob/main/static/imgs/fig6-5.png){alt='A screenshot of the NGIAB and DataStream Visualizer web interface. The map displays the ability of the visualizer to retrieve time series from Catchments variables'}

**TEEHR** evaluation can be visualized when the user hits a point that contains **TEEHR** evaluation output, the user can also look at a **Nexus** point on the dropdown assigned and enter the id of the **Nexus** points that contains **TEEHR** evaluation output.

[![Figure 6: A map showing the geospatial visualization using the Data Visualizer within the Tethys framework for a selected outlet nexus point as well as displaying a time series plot between observed (labeled "USGS"; blue line) and simulated (labeled "ngen"; orange line)](https://github.com/CIROH-UA/ngiab-client/raw/main/static/imgs/fig6-6.png)](https://github.com/CIROH-UA/ngiab-client/blob/main/static/imgs/fig6-6.png){alt='alt='A screenshot of the NGIAB and DataStream Visualizer web interface. The left panel contains a "Time Series Menu" where the user can select a Nexus ID, variable (e.g., flow), and TEEHR data source. A map in the center displays a stream reach with a highlighted section representing the drainage basin and a blue point, indicating the selected nexus location. Below the map, a time series plot compares USGS (blue line) and Ngen (orange line) streamflow data from 2017 to 2023.'}

Similarly, a **TEEHR** evaluation metric can be visualized by going to the metrics tab

[Figure 7: NGIAB Visualizer performance metrics (KGE, NSE, and relative bias). The Visualizer can also show the performance of the NWM 3.0 compared to the observed time series.](https://github.com/CIROH-UA/ngiab-client/blob/main/static/imgs/fig6-7.png){alt='A screenshot of the NGIAB and DataStream Visualizer web interface. The map displays the ability of the visualizer to retrieve the TEEHR metrics on a table."Teehr Metrics" presents performance metrics (e.g., Kling-Gupta Efficiency, Nash-Sutcliffe Efficiency, and Relative Bias) for the selected model versus reference data.'}

### DataStream Integration

The Visualizer also allows the user to download data as well from an [S3 bucket](https://datastream.ciroh.org/index.html) containing the output of the [NextGen DataStream](https://github.com/CIROH-UA/ngen-datastream). The `ViewOnTethys.sh` script will create a `~/.datastream_ngiab` directory in which it saves all the different outputs downloaded by the visualizer. It will also create a `~/.datastream_ngiab/datastream_ngiab.json` in which metadata will be saved to locate the downloaded output directories. It serves as a cache, so it allows the user to look first at the `~/.datastream_ngiab` before trying to download the data

```
ℹ Reclaiming ownership of /home/aquagio/.datastream_ngiab  (sudo may prompt)…
  ℹ No existing Datastream cache found – a fresh download will be used.
```

The `.datastream_ngiab.json` appends the different downloads with metadata that allows the user to know the file being downloaded. The `prefix` belongs to the path on the s3 bucket. The `label` is created with the following format: `ngen.<date>_<forecast_type>_<cycle>_<VPU>`

```
{
    "datastream": [\
        {\
            "label": "ngen.20250522_medium_range_06_VPU_02",\
            "bucket": "ciroh-community-ngen-datastream",\
            "prefix": "v2.2/ngen.20250522/medium_range/06/VPU_02/ngen-run.tar.gz",\
            "path": "/var/lib/tethys_persist/.datastream_ngiab/ngen.20250522_medium_range_06_VPU_02",\
            "date": "2021-01-01:00:00:00",\
            "id": "15145d327f19426b890e4465160f963a"\
        }\
    ]
}
```

> **_NOTE:_** assuming only the first ensemble. If we are specific it will look like this: `ngen.<date>_<forecast_type>_<cycle>_<ensemble>_<VPU>`

This functionality allows the user to be able to quicklu search the data they want from the [S3 bucket](https://datastream.ciroh.org/index.html) containing the output of the [NextGen DataStream](https://github.com/CIROH-UA/ngen-datastream). They can explore and download as needed.

[![Figure 8: NGIAB Visualizer Visualization of DataStream Data](https://github.com/CIROH-UA/ngiab-client/raw/main/static/imgs/fig6-8.png)](https://github.com/CIROH-UA/ngiab-client/blob/main/static/imgs/fig6-8.png){alt='A screenshot of the NGIAB and DataStream Visualizer web interface displaying the hydrofabric for DataStream output'}

## Development Installation

You need to install both the Tethys dependencies and the node dependencies.

The webpack dev server is configured to proxy the Tethys development server (see `webpack.config.js`). The app endpoint will be handled by the webpack development server and all other endpoints will be handled by the Tethys (Django) development server. As such, you will need to start both in separate terminals.

0. First create a Virtual Environment with the tool of your choice and then run the following commands

1. Install libmamba and make it your default solver (see: A Faster Solver for Conda: Libmamba):



```
conda update -n base conda
conda install -n base conda-libmamba-solver
conda config --set solver libmamba

```

2. Install the Tethys Platform

Using `conda`



```
conda install -c conda-forge tethys-platform django=<DJANGO_VESION>

```



or using `pip`



```
pip install tethys-platform django=<DJANGO_VERSION>


```

3. Create a `portal_config.yml` file :

To add custom configurations such as the database and other local settings you will need to generate a portal\_config.yml file. To generate a new template portal\_config.yml run:



```
tethys gen portal_config
```



You can customize your settings in the portal\_config.yml file after you generate it by manually editing the file or by using the settings command command. Refer to the Tethys Portal Configuration documentation for more information.

4. Configure the Tethys Database

There are several options for setting up a DB server: local, docker, or remote. Tethys Platform uses a local SQLite database by default. For development environments you can use Tethys to create a local server:



```
tethys db configure
```

5. Install Node Version Manager and Node.js:

5.1 Install Node Version Manager (nvm): [https://github.com/nvm-sh/nvm?tab=readme-ov-file#install--update-script](https://github.com/nvm-sh/nvm?tab=readme-ov-file#install--update-script)

5.2 CLOSE ALL OF YOUR TERMINALS AND OPEN NEW ONES

5.3 Use NVM to install Node.js 20:



```
nvm install 20
nvm use 20
```

6. Install the PDM dependency manager:



```
pip install --user pdm
```




> **_NOTE:_** if you have previously installed pdm in another environment, uninstall pdm first ( `pip uninstall pdm`), and then reinstall as shown above with the new environment active.

7. Clone the app and install into the Tethys environment in development mode:



```
git clone https://github.com/CIROH-UA/ngiab-client.git
cd ngiab-client
pdm install
npm install --include=dev
cd ../
```


## PDM Tips

See below for more PDM tips like how to manage dependencies, install dependencies, and run scripts.

### Install only dev dependencies

- Install all dev dependencies (test & lint)



```
pdm install -G:all
```

- Install only test dependencies



```
pdm install -G test
```

- Install only lint and formatter dependencies



```
pdm install -G lint
```


### Managing dependencies

- Add a new dependency:

1. Add the package using `pdm`:



```
pdm add <package-name>
```

2. Manually add the dependency to the `install.yml`.


> **_IMPORTANT:_** Dependencies are not automatically added to the `install.yml` yet!


- Add a new dev dependency:



```
pdm add -dG test <package-name>
pdm add -dG lint <package-name>
```




> **_NOTE:_** Just use `pdm` to install and manage dev dependencies. The `install.yml` does not support dev dependencies, but they shouldn't be needed in it anyway, right?

- Add a new optional dependeny:



```
pdm add -G <group-name> <package-name>
```




> **_NOTE:_** You'll need to decide whether or not to add the optional dependencies to the `install.yml` b/c it does not support optional dependencies. You may consider using `pdm` to manage the optional dependencies.

- Remove a dependency:


1. Remove it from the `pyproject.yaml` and lock file:



```
pdm remove --no-sync <package-name>
```

2. Manually remove it from the `install.yml`

3. If you want to remove it from the environment, use `pip` or `conda` to remove the package.


> **_IMPORTANT:_** TL;DR: Running `pdm remove` without the `--no-sync` will remove nearly all of the dependencies in your environment. While `pdm remove` is capable of removing the package from the environment, running `pdm remove` without the `--no-sync` option can break your Tethys environment. This is because `pdm` will attempt to get the environment to match the dependencies listed in your `pyproject.toml`, which usually does not include all of the dependencies of Tethys.


### PDM Scripts

The project is configured with several PDM convenience scripts:

```
# Run linter
pdm run lint

# Run formatter
pdm run format

# Run tests
pdm run test

# Run all checks
pdm run all
```

## Formatting and Linting Manually

This package is configured to use yapf code formatting

1. Install lint dependencies:



```
pdm install -G lint
```

2. Run code formatting from the project directory:



```
yapf --in-place --recursive --verbose .

# Short version
yapf -ir -vv .
```

3. Run linter from the project directory:



```
flake8 .
```




> **_NOTE:_** The configuration for yapf and flake8 is in the `pyproject.toml`.


## Testing Manually

This package is configured to use pytest for testing

1. Install test dependencies:



```
pdm install -G test
```

2. Run tests from the project directory:



```
pytest
```




> **_NOTE:_** The configuration for pytest and coverage is in the `pyproject.toml`.


## Build Node Modules

Webpack is configured to bundle and build the React app into the `tethysapp/<app_package>/public/frontend` directory. Before building a Python distribution for release, you should build using this command:

```
npm run build

```

## Test Node Modules

Use the following commands to lint and test the React portion of the app.

```
npm run lint
npm run test

```

The linting capability is powered by [eslint](https://eslint.org/) and a number of plugins for React. The testing capabilities include [jest](https://jestjs.io/), [jsdom](https://github.com/jsdom/jsdom#readme), [testing-framework](https://testing-library.com/), [user-event](https://testing-library.com/docs/user-event/intro/), and a few other JavaScript testing utilties to make it easy to test the frontend of the React-Tethys app.

## Acknowledgements

The React + Django implementation is based on the excellent work done by @Jitensid that can be found on GitHub here: [Jitensid/django-webpack-dev-server](https://github.com/Jitensid/django-webpack-dev-server).

## Contribute

Please feel free to contribute!